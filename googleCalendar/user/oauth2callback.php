<?php

// ×›×“×™ ×©× ×•×›×œ ×œ×©××•×¨ ××ª ×”×˜×•×§×Ÿ
session_start();


// oauth2callback.php - ×˜×™×¤×•×œ ×‘×ª×©×•×‘×” ××’×•×’×œ:
// ×”×©×œ×‘ ×”×©× ×™ ×‘×ª×”×œ×™×š ×”×”×¨×©××” 
// ×›××Ÿ ×× ×—× ×• ××§×‘×œ×™× ××ª ×§×•×“ ×”×”×¨×©××” ×©×’×•×’×œ ××—×–×™×¨×” ×œ× ×•, ×•×××™×¨×™× ××•×ª×• ×œÖ¾ access token ×•Ö¾refresh token.

// ×§×‘×œ×ª ×§×•×“ ×”×”×¨×©××” ×•×”×—×œ×¤×ª×• ×‘×˜×•×§×Ÿ ×’×™×©×”
// ×‘×“×™×§×•×ª ××‘×˜×—×” (state validation)
// ×˜×™×¤×•×œ ×‘×©×’×™××•×ª ×•×”×¦×’×ª ×”×•×“×¢×•×ª ××ª××™××•×ª
// ×”×¤× ×™×” ××•×˜×•××˜×™×ª ×‘××§×¨×” ×©×œ ×”×¦×œ×—×”

// ×”×’×“×¨×•×ª OAuth ×©×œ Google - ××§×‘×œ×™× ××ª ×”×¢×¨×›×™× ×”××œ×” ×- Google Cloud Console
$client_id = '929814436812-f7k03a3sq083jivb20qrppevh5fpbm2b.apps.googleusercontent.com'; // // ××–×”×” ×™×™×—×•×“×™ ×©×œ ×”××¤×œ×™×§×¦×™×”
$client_secret = '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'; // 
$redirect_uri = 'https://itayrm.mtacloud.co.il/Itay-testing-zone/finalProject/googleCalendar/user/oauth2callback.php'; // ×›×ª×•×‘×ª ×”×—×–×¨×” ××—×¨×™ ×”×”×¨×©××”

// ××©×ª× ×™× ×œ×©××™×¨×ª ××¦×‘ ×”×©×’×™××”/×”×¦×œ×—×”
$error = null;
$success = false;


// ×× ×’×•×’×œ ×”×—×–×™×¨×” ×©×’×™××” (×œ××©×œ ×”××©×ª××© ×‘×™×˜×œ ××ª ×”×”×¨×©××”)
if (isset($_GET['error'])) {
    $error = "×©×’×™××” × Google: " . $_GET['error'];

    // ×× ×”×ª×©×•×‘×” ×©×”×ª×§×‘×œ×” ××’×•×’×œ ×œ× ×›×•×œ×œ×ª ××—×¨×•×–×ª ××‘×˜×—×”, ××• ×©××—×¨×•×–×ª ×”××‘×˜×—×” ×œ× ×ª×•×××ª ×œ××—×¨×•×–×ª ×©× ×©××¨×” ×‘×¡×©×Ÿ ×›×©×©×œ×—× ×• ×‘×”×ª×—×œ×” ××ª ×”×‘×§×©×” ×œ×’×•×’×œ
    // Cross-Site Request Forgery ×‘×“×™×§×ª ××‘×˜×—×” ×œ×¦×•×¨×š ×× ×™×¢×ª ×”×ª×§×¤×•×ª 
} elseif (!isset($_GET['state']) || $_GET['state'] != $_SESSION['oauth_state']) {
    $error = "×©×’×™××ª ××‘×˜×—×”: ××—×¨×•×–×ª ×”××‘×˜×—×” ×œ× ×ª×§×™× ×” ×•×œ× ×ª×•×××ª ×œ××©×ª× ×” ×”×¡×©×Ÿ";

  // ×‘×“×™×§×” ×©×§×™×‘×œ× ×• ×§×•×“ ×”×¨×©××” ××’×•×’×œ
} elseif (!isset($_GET['code'])) {
    $error = "×œ× ×”×ª×§×‘×œ ×§×•×“ ×”×¨×©××” × Google";

} else {
    // ×× ×”×›×œ ×ª×§×™×Ÿ, ×××©×™×›×™× ×œ×¢×™×‘×•×“
    $code = $_GET['code'];
    
    //  ×©×œ×™×—×ª ×”×‘×§×©×” ×‘×©×‘×™×œ ×œ×”××™×¨ ××ª ×”×§×•×“ ×œ×˜×•×§×Ÿ
    // ×”×©×œ×‘ ×”×©× ×™ ×©×œ OAuth - ×”×—×œ×¤×ª ×”×§×•×“ ×‘×˜×•×§×Ÿ ×’×™×©×”
    // ×–××ª ×”×›×ª×•×‘×ª ×©×œ ×’×•×’×œ ×©××œ×™×” ×©×•×œ×—×™× ××ª ×”×‘×§×©×” ×›×“×™ ×œ×”×—×œ×™×£ ××ª ×”×§×•×“ ×”×¨×©××” ×‘×˜×•×§×Ÿ ×’×™×©×”
    $token_url = 'https://oauth2.googleapis.com/token';
    // ×‘×•× ×” ××ª ×”× ×ª×•× ×™× ×©×™×™×©×œ×—×• ×œ×’×•×’×œ
    $post_data = array(
        'client_id' => $client_id, // ××–×”×” ××ª ×”××¤×œ×™×§×¦×™×” ××•×œ ×’×•×’×œ
        'client_secret' => $client_secret, // ××¤×ª×— ×¡×•×“×™ ×‘×™×Ÿ ×”××¤×œ×™×§×¦×™×” ×œ×’×•×’×œ
        'code' => $code, // ×–×” ×§×•×“ ×”×”×¨×©××” ×©×’×•×’×œ ×”×—×–×™×¨×” ×œ××—×¨ ×§×‘×œ×ª ×”×”×¨×©××” (×‘×©×œ×‘ ×”×§×•×“×). ××©×ª××©×™× ×‘×©×‘×™×œ ×œ×§×‘×œ ×˜×•×§×Ÿ ×”×¨×©××”
        'grant_type' => 'authorization_code', // ××™×–×” ×¡×•×’ ×©×œ ×ª×”×œ×™×š ×”×¨×©××” ×× ×—× ×• ××‘×¦×¢×™×
        'redirect_uri' => $redirect_uri // ×—×™×™×‘ ×œ×”×™×•×ª ×–×”×” ×œ×–×” ×©×©×œ×—× ×• ×‘×©×œ×‘ ×”×¨××©×•×Ÿ - ×œ××Ÿ ×’×•×’×œ ×ª×—×–×™×¨ ××ª ×”××©×ª××©
    );

    // ×”×›× ×ª ×‘×§×©×ª cURL ×œ×”×—×œ×¤×ª ×”×§×•×“ ×‘×˜×•×§×Ÿ
    // ×¤×ª×™×—×ª "×©×™×—×”" ×¢× ×©×¨×ª ×©×œ ×’×•×’×œ
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $token_url); // ×§×•×‘×¢ ××ª ×”×›×ª×•×‘×ª ×œ×‘×§×©×”
    curl_setopt($ch, CURLOPT_POST, true); //  ××’×“×™×¨ ×©×”×‘×§×©×” ×ª×™×©×œ×— ×›Ö¾ HTTP POST â€“ ×•×œ× GET, ×‘×©×‘×™×œ ×©×”× ×ª×•× ×™× ×œ× ×™×”×™×• ×—×œ×§ ××”×›×ª×•×‘×ª
    curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($post_data)); // ×ª×•×›×Ÿ ×”×‘×§×©×”
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); // ×‘××§×•× ×œ×”×“×¤×™×¡ ×™×©×™×¨×•×ª ××ª ×”×ª×’×•×‘×”, ××—×–×™×¨ ××•×ª×” ×œ×ª×•×š ××©×ª× ×”
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false); // ×‘××¢×¨×›×ª production ×›×“××™ ×œ×”×¤×¢×™×œ ××ª ×–×”

    // ×‘×™×¦×•×¢ ×”×‘×§×©×”
    // ××‘×¦×¢ ×‘×¤×•×¢×œ ××ª ×”×‘×§×©×” ×œ×’×•×’×œ ×•××—×–×™×¨ ××ª ×”×‘×§×©×” ×›××—×¨×•×–×ª JSON
    $response = curl_exec($ch);

    // ×©×•×œ×£ ××ª ×§×•×“ ×”×ª×’×•×‘×” ××”×©×¨×ª ×©×œ ×’×•×’×œ ××œ×™×• ×¤× ×™× ×•: 200, 400,401,500
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);


    // ×˜×™×¤×•×œ ×‘×ª×’×•×‘×” ××”×©×¨×ª ×©×œ ×’×•×’×œ ××—×¨×™ ×©×œ×™×—×ª ×”×‘×§×©×”
    // ×‘×“×™×§×ª ×©×’×™××•×ª ×‘×‘×§×©×”
    // ×× ×”×™×™×ª×” ×©×’×™××ª ×—×™×‘×•×¨ ××• ×ª×§×œ×” ×˜×›× ×™×ª
    if (curl_error($ch)) {
        $error = "×©×’×™××ª cURL: " . curl_error($ch);

        // ×× ×’×•×’×œ ×”×—×–×™×¨×” ×§×•×“ ×©×’×™××”
        // 200 = ×”×¦×œ×—×”
    } elseif ($http_code != 200) {
        $error = "×©×’×™××” ×‘×§×‘×œ×ª ×˜×•×§×Ÿ (HTTP $http_code): " . $response;


        // ×× ××™×Ÿ ×©×’×™××” ×¢×“ ×›×” â€“ ××¤×¢× ×—×™× ××ª ×”×ª×©×•×‘×” ×Ö¾ JSON ×œ××¢×¨×š
    } else {
        // ×”××¨×” × JSON ×œ××™×œ×•×Ÿ
        $token_data = json_decode($response, true);
        
        // ×× ×”×¤×¢× ×•×— × ×›×©×œ ××• ×× ×™×© ×©×“×” ×©×’×™××” ×‘×ª×©×•×‘×” ×©×”×ª×§×‘×œ×” ××’×•×’×œ
        if (!$token_data || isset($token_data['error'])) {
            $error = "×©×’×™××” ×‘×”××¨×” ×œ×˜×•×§×Ÿ";
            if (isset($token_data['error_description'])) {
                $error .= ": " . $token_data['error_description'];
            }

            // ×©××™×¨×ª ×˜×•×§×Ÿ ×”×’×™×©×” ×‘×¡×©×Ÿ â€“ ×›×š ×©× ×•×›×œ ×œ×”×©×ª××© ×‘×• ×‘×‘×§×©×•×ª ×œ×’×•×’×œ ×§××œ×× ×“×¨
        } else {
            $_SESSION['access_token'] = $token_data['access_token']; // ×˜×•×§×Ÿ ×”×’×™×©×” ×œ×©×™××•×© ×‘ - API

            // ×× ×’×•×’×œ ×©×œ×—×” ×’× ×˜×•×§×Ÿ ×œ×©×—×–×•×¨ ×©×•××¨×™× ××•×ª×• ×’× ×›×Ÿ
            if (isset($token_data['refresh_token'])) {
                // refresh token ×××¤×©×¨ ×œ×§×‘×œ ×˜×•×§×Ÿ ×—×“×© ×›×©×”×§×™×™× ×™×¤×•×’ ×‘×œ×™ ×©×”××©×ª××© ×™×¦×˜×¨×š ×œ×”×ª×—×‘×¨ ×©×•×‘
                $_SESSION['refresh_token'] = $token_data['refresh_token'];
            }
            //  ×¡×™××•×Ÿ ×©×”×›×•×œ ×¢×‘×¨ ×‘×”×¦×œ×—×”
            $success = true;
        }
    }
    
    // ×¡×™×•× ×”×©×™×—×” ××•×œ ×”×©×¨×ª ×©×œ ×’×•×’×œ
    curl_close($ch);
}

// ×”×× ×ª×”×œ×™×š ×§×‘×œ×ª ×”×˜×•×§×Ÿ ×”×¦×œ×™×—
//  ×”×× ×¢×“×™×™×Ÿ ××¤×©×¨ ×œ×©×œ×•×— ×›×•×ª×¨×•×ª
// ×× ×›×‘×¨ × ×©×œ×— ×ª×•×›×Ÿ ×œ×“×¤×“×¤×Ÿ ×œ× × ×™×ª×Ÿ ×œ×©×œ×•×— ×¢×•×“ ×ª×•×›×Ÿ ×œ×“×¤×“×¤×Ÿ ×›×™ ××—×¨×ª ×–×” ×™×’×¨×•× ×œ×©×’×™××”

if ($success && !headers_sent()) {
    //  ××¤× ×™× ×œ×“×£ ×™×¦×™×¨×ª ×”××™×¨×•×¢×™× ×‘×’×•×’×œ ×§××œ×× ×“×¨ ×©×œ ×”××©×ª××©
    header('Location: create_events.php');
    exit(); // ××¤×¡×™×§ ××ª ×”×¨×™×¦×” ×©×œ ×”×¡×§×¨×™×¤×˜ ××™×™×“ ×›×š ×©×œ× ×™×ª×‘×¦×¢ ×©×•× ×§×•×“ × ×•×¡×£ ×‘×˜×¢×•×ª (×•×œ× ×™×•×“×¤×¡ ×›×œ×•× ×œ××¡×š)
}
?>
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×ª×•×¦××ª ×”×¨×©××”</title>
    <style>
        /* ×¢×™×¦×•×‘ ×‘×¡×™×¡×™ ×©×œ ×”×“×£ */
        body { 
            font-family: Arial, sans-serif; 
            max-width: 600px; 
            margin: 50px auto; 
            padding: 20px; 
            text-align: center; 
        }
        
        /* ×¢×™×¦×•×‘ ×”×•×“×¢×ª ×”×¦×œ×—×” */
        .success { 
            background: #d4edda; /* ×¨×§×¢ ×™×¨×•×§ ×‘×”×™×¨ */
            padding: 20px; 
            border-radius: 5px; 
            color: #155724; /* ×˜×§×¡×˜ ×™×¨×•×§ ×›×”×” */
            border: 1px solid #c3e6cb; 
        }
        
        /* ×¢×™×¦×•×‘ ×”×•×“×¢×ª ×©×’×™××” */
        .error { 
            background: #f8d7da; /* ×¨×§×¢ ××“×•× ×‘×”×™×¨ */
            padding: 20px; 
            border-radius: 5px; 
            color: #721c24; /* ×˜×§×¡×˜ ××“×•× ×›×”×” */
            border: 1px solid #f5c6cb; 
        }
        
        /* ×¢×™×¦×•×‘ ×›×¤×ª×•×¨×™× */
        .btn { 
            display: inline-block; 
            background: #007bff; 
            color: white; 
            padding: 15px 30px; 
            text-decoration: none; 
            border-radius: 5px; 
            margin: 10px; 
        }
    </style>
</head>
<body>
    <?php if ($success): ?>
        <!-- ×”×•×“×¢×ª ×”×¦×œ×—×” -->
        <div class="success">
            <h2>ğŸ‰ ×”×¨×©××” ×”×¦×œ×™×—×”!</h2>
            <p>×”×˜×•×§×Ÿ × ×©××¨ ×‘×”×¦×œ×—×”. ×¢×›×©×™×• × ×•×›×œ ×œ×™×¦×•×¨ ××™×¨×•×¢×™× ×‘×œ×•×— ×”×©× ×” ×©×œ×š.</p>
            <a href="create_events.php" class="btn">×”××©×š ×œ×™×¦×™×¨×ª ××™×¨×•×¢×™×</a>
        </div>
    <?php else: ?>
        <!-- ×”×•×“×¢×ª ×©×’×™××” -->
        <div class="error">
            <h2>âŒ ×©×’×™××” ×‘×”×¨×©××”</h2>
            <p><?php echo htmlspecialchars($error); ?></p>
            <a href="index.html" class="btn">×—×–×•×¨ ×œ×“×£ ×”×‘×™×ª</a>
            <a href="authorize.php" class="btn">× ×¡×” ×©×•×‘</a>
        </div>
    <?php endif; ?>
</body>
</html>